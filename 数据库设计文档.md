# æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> ä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿæ•°æ®åº“è®¾è®¡  
> åŸºäºSupabase PostgreSQL  
> æ›´æ–°æ—¶é—´: 2025å¹´2æœˆ1æ—¥  
> ç‰ˆæœ¬: v2.1.0

## ğŸ¯ è®¾è®¡æ¦‚è¿°

æœ¬ç³»ç»Ÿé‡‡ç”¨Supabase PostgreSQLä½œä¸ºä¸»æ•°æ®åº“ï¼Œè®¾è®¡éµå¾ªå…³ç³»å‹æ•°æ®åº“è§„èŒƒåŒ–åŸåˆ™ï¼Œé€šè¿‡å¤–é”®å…³è”å’Œä¸­é—´è¡¨å®ç°æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚æ•°æ®åº“åŒ…å«äº”ä¸ªæ ¸å¿ƒè¡¨ï¼šä¾›åº”å•†è¡¨ã€å•†å“è¡¨ã€ä¾›åº”å•†-å•†å“å…³è”è¡¨ã€å…¥åº“è®°å½•è¡¨å’Œå‡ºåº“è®°å½•è¡¨ã€‚

## ğŸ“Š æ•°æ®åº“æ¶æ„

### æ ¸å¿ƒè¡¨å…³ç³»
```
suppliers (ä¾›åº”å•†è¡¨)
    â†“ (M:N) é€šè¿‡ supplier_products ä¸­é—´è¡¨
products (å•†å“è¡¨)
    â†“ (1:N)
inbound_records (å…¥åº“è®°å½•è¡¨) â† product_id, supplier_id
    â†“ (1:N)  
outbound_records (å‡ºåº“è®°å½•è¡¨) â† product_id

supplier_products (ä¾›åº”å•†-å•†å“å…³è”è¡¨)
    â† supplier_id (M:1) suppliers
    â† product_id (M:1) products
```

## ğŸ“‹ è¡¨ç»“æ„è®¾è®¡

### 1. suppliers (ä¾›åº”å•†è¡¨)

**è¡¨å**: `suppliers`  
**æè¿°**: å­˜å‚¨ä¾›åº”å•†åŸºæœ¬ä¿¡æ¯å’Œè”ç³»æ–¹å¼

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | æè¿° |
|--------|----------|------|--------|------|
| id | SERIAL | PRIMARY KEY | AUTO | ä¾›åº”å•†å”¯ä¸€æ ‡è¯† |
| name | VARCHAR(255) | NOT NULL | - | ä¾›åº”å•†åç§° |
| contact | VARCHAR(100) | NOT NULL | - | è”ç³»äººå§“å |
| phone | VARCHAR(20) | NOT NULL | - | è”ç³»ç”µè¯ |
| address | TEXT | NULL | - | ä¾›åº”å•†åœ°å€ |
| paymentMethod | VARCHAR(50) | NOT NULL | - | ä»˜æ¬¾æ–¹å¼ |
| hasInvoice | BOOLEAN | NOT NULL | false | æ˜¯å¦å¼€å…·å‘ç¥¨ |
| status | VARCHAR(20) | NOT NULL | 'active' | ä¾›åº”å•†çŠ¶æ€ |
| remark | TEXT | NULL | - | å¤‡æ³¨ä¿¡æ¯ |
| created_at | TIMESTAMP | NOT NULL | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | NOW() | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•è®¾è®¡**:
```sql
-- ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
CREATE INDEX idx_suppliers_id ON suppliers(id);

-- åç§°ç´¢å¼•ï¼ˆç”¨äºæœç´¢ï¼‰
CREATE INDEX idx_suppliers_name ON suppliers(name);

-- çŠ¶æ€ç´¢å¼•ï¼ˆç”¨äºç­›é€‰ï¼‰
CREATE INDEX idx_suppliers_status ON suppliers(status);
```

**ç¤ºä¾‹æ•°æ®**:
```json
{
  "id": 8,
  "name": "åŒ—äº¬é£Ÿå“ä¾›åº”å•†",
  "contact": "å¼ ç»ç†",
  "phone": "13800138001",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒºå»ºå›½è·¯88å·",
  "paymentMethod": "é“¶è¡Œè½¬è´¦",
  "hasInvoice": true,
  "status": "active",
  "remark": "é•¿æœŸåˆä½œä¼™ä¼´ï¼Œä¿¡èª‰è‰¯å¥½"
}
```

### 2. products (å•†å“è¡¨)

**è¡¨å**: `products`  
**æè¿°**: å­˜å‚¨å•†å“åŸºæœ¬ä¿¡æ¯ã€ä»·æ ¼å’Œåº“å­˜æ•°æ®

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | æè¿° |
|--------|----------|------|--------|------|
| id | SERIAL | PRIMARY KEY | AUTO | å•†å“å”¯ä¸€æ ‡è¯† |
| name | VARCHAR(255) | NOT NULL | - | å•†å“åç§° |
| brand | VARCHAR(100) | NOT NULL | - | å•†å“å“ç‰Œ |
| category | VARCHAR(100) | NOT NULL | - | å•†å“åˆ†ç±» |
| specification | VARCHAR(100) | NOT NULL | - | å•†å“è§„æ ¼ |
| purchasePrice | DECIMAL(10,2) | NOT NULL | - | è¿›è´§ä»·æ ¼ |
| inputPrice | DECIMAL(10,2) | NOT NULL | - | å½•å…¥ä»·æ ¼ |
| retailPrice | DECIMAL(10,2) | NOT NULL | - | é›¶å”®ä»·æ ¼ |
| currentStock | INTEGER | NOT NULL | 0 | å½“å‰åº“å­˜æ•°é‡ |
| stockAlert | INTEGER | NULL | 10 | åº“å­˜é¢„è­¦å€¼ |
| unit | VARCHAR(20) | NOT NULL | - | è®¡é‡å•ä½ |
| barcode | VARCHAR(50) | NULL | - | å•†å“æ¡ç  |
| created_at | TIMESTAMP | NOT NULL | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | NOW() | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•è®¾è®¡**:
```sql
-- ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
CREATE INDEX idx_products_id ON products(id);

-- å•†å“åç§°ç´¢å¼•ï¼ˆç”¨äºæœç´¢ï¼‰
CREATE INDEX idx_products_name ON products(name);

-- å“ç‰Œåˆ†ç±»å¤åˆç´¢å¼•
CREATE INDEX idx_products_brand_category ON products(brand, category);

-- æ¡ç å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_products_barcode ON products(barcode) WHERE barcode IS NOT NULL;

-- åº“å­˜é¢„è­¦ç´¢å¼•
CREATE INDEX idx_products_stock_alert ON products(currentStock, stockAlert);
```

**ç¤ºä¾‹æ•°æ®**:
```json
{
  "id": 15,
  "name": "å¯å£å¯ä¹",
  "brand": "å¯å£å¯ä¹",
  "category": "é¥®æ–™",
  "specification": "500ml",
  "purchasePrice": 2.50,
  "inputPrice": 2.80,
  "retailPrice": 3.50,
  "currentStock": 100,
  "stockAlert": 20,
  "unit": "ç“¶",
  "barcode": "6901234567890"
}
```

### 3. supplier_products (ä¾›åº”å•†-å•†å“å…³è”è¡¨)

**è¡¨å**: `supplier_products`  
**æè¿°**: ç®¡ç†ä¾›åº”å•†ä¸å•†å“çš„å¤šå¯¹å¤šå…³ç³»

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | æè¿° |
|--------|----------|------|--------|------|
| id | SERIAL | PRIMARY KEY | AUTO | å…³è”è®°å½•å”¯ä¸€æ ‡è¯† |
| supplier_id | INTEGER | NOT NULL | - | å…³è”ä¾›åº”å•†ID |
| product_id | INTEGER | NOT NULL | - | å…³è”å•†å“ID |
| is_primary | BOOLEAN | NOT NULL | false | æ˜¯å¦ä¸ºä¸»è¦ä¾›åº”å•† |
| created_at | TIMESTAMP | NOT NULL | NOW() | åˆ›å»ºæ—¶é—´ |

**å¤–é”®çº¦æŸ**:
```sql
ALTER TABLE supplier_products 
ADD CONSTRAINT fk_supplier_products_supplier 
FOREIGN KEY (supplier_id) REFERENCES suppliers(id) 
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE supplier_products 
ADD CONSTRAINT fk_supplier_products_product 
FOREIGN KEY (product_id) REFERENCES products(id) 
ON DELETE CASCADE ON UPDATE CASCADE;

-- å”¯ä¸€çº¦æŸï¼šåŒä¸€ä¾›åº”å•†å’Œå•†å“åªèƒ½æœ‰ä¸€æ¡å…³è”è®°å½•
ALTER TABLE supplier_products 
ADD CONSTRAINT uk_supplier_product 
UNIQUE (supplier_id, product_id);
```

**ç´¢å¼•è®¾è®¡**:
```sql
-- ä¾›åº”å•†å¤–é”®ç´¢å¼•
CREATE INDEX idx_supplier_products_supplier ON supplier_products(supplier_id);

-- å•†å“å¤–é”®ç´¢å¼•
CREATE INDEX idx_supplier_products_product ON supplier_products(product_id);

-- ä¸»è¦ä¾›åº”å•†ç´¢å¼•
CREATE INDEX idx_supplier_products_primary ON supplier_products(is_primary) WHERE is_primary = true;
```

**ç¤ºä¾‹æ•°æ®**:
```json
{
  "id": 1,
  "supplier_id": 8,
  "product_id": 15,
  "is_primary": true,
  "created_at": "2025-01-31T10:00:00Z"
}
```
### 4. inbound_records (å…¥åº“è®°å½•è¡¨)

**è¡¨å**: `inbound_records`  
**æè¿°**: è®°å½•å•†å“å…¥åº“æ“ä½œçš„è¯¦ç»†ä¿¡æ¯

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | æè¿° |
|--------|----------|------|--------|------|
| id | SERIAL | PRIMARY KEY | AUTO | å…¥åº“è®°å½•å”¯ä¸€æ ‡è¯† |
| product_id | INTEGER | NOT NULL | - | å…³è”å•†å“ID |
| supplier_id | INTEGER | NOT NULL | - | å…³è”ä¾›åº”å•†ID |
| quantity | INTEGER | NOT NULL | - | å…¥åº“æ•°é‡ |
| unit_price | DECIMAL(10,2) | NOT NULL | - | å…¥åº“å•ä»· |
| total_amount | DECIMAL(10,2) | NOT NULL | - | å…¥åº“æ€»é‡‘é¢ |
| date | DATE | NOT NULL | - | å…¥åº“æ—¥æœŸ |
| notes | TEXT | NULL | - | å¤‡æ³¨ä¿¡æ¯ |
| created_by | VARCHAR(100) | NOT NULL | 'system' | åˆ›å»ºäºº |
| updated_by | VARCHAR(100) | NOT NULL | 'system' | æ›´æ–°äºº |
| created_at | TIMESTAMP | NOT NULL | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | NOW() | æ›´æ–°æ—¶é—´ |

**å¤–é”®çº¦æŸ**:
```sql
ALTER TABLE inbound_records 
ADD CONSTRAINT fk_inbound_product 
FOREIGN KEY (product_id) REFERENCES products(id) 
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE inbound_records 
ADD CONSTRAINT fk_inbound_supplier 
FOREIGN KEY (supplier_id) REFERENCES suppliers(id) 
ON DELETE CASCADE ON UPDATE CASCADE;
```

**ç´¢å¼•è®¾è®¡**:
```sql
-- å•†å“å¤–é”®ç´¢å¼•
CREATE INDEX idx_inbound_product_id ON inbound_records(product_id);

-- ä¾›åº”å•†å¤–é”®ç´¢å¼•
CREATE INDEX idx_inbound_supplier_id ON inbound_records(supplier_id);

-- æ—¥æœŸç´¢å¼•ï¼ˆç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼‰
CREATE INDEX idx_inbound_date ON inbound_records(date);

-- å¤åˆç´¢å¼•ï¼ˆå•†å“+æ—¥æœŸï¼‰
CREATE INDEX idx_inbound_product_date ON inbound_records(product_id, date);
```

**ç¤ºä¾‹æ•°æ®**:
```json
{
  "id": 25,
  "product_id": 15,
  "supplier_id": 8,
  "quantity": 50,
  "unit_price": 2.50,
  "total_amount": 125.00,
  "date": "2025-01-08",
  "notes": "æ­£å¸¸å…¥åº“ï¼Œè´¨é‡è‰¯å¥½",
  "created_by": "system",
  "updated_by": "system",
  "created_at": "2025-02-01T10:00:00Z",
  "updated_at": "2025-02-01T10:00:00Z"
}
```

### 5. outbound_records (å‡ºåº“è®°å½•è¡¨)

**è¡¨å**: `outbound_records`  
**æè¿°**: è®°å½•å•†å“å‡ºåº“æ“ä½œçš„è¯¦ç»†ä¿¡æ¯

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | æè¿° |
|--------|----------|------|--------|------|
| id | SERIAL | PRIMARY KEY | AUTO | å‡ºåº“è®°å½•å”¯ä¸€æ ‡è¯† |
| product_id | INTEGER | NOT NULL | - | å…³è”å•†å“ID |
| quantity | INTEGER | NOT NULL | - | å‡ºåº“æ•°é‡ |
| unit_price | DECIMAL(10,2) | NOT NULL | - | å‡ºåº“å•ä»· |
| total_amount | DECIMAL(10,2) | NOT NULL | - | å‡ºåº“æ€»é‡‘é¢ |
| date | DATE | NOT NULL | - | å‡ºåº“æ—¥æœŸ |
| customer_name | VARCHAR(100) | NULL | - | å®¢æˆ·åç§° |
| notes | TEXT | NULL | - | å¤‡æ³¨ä¿¡æ¯ |
| status | VARCHAR(20) | NOT NULL | 'completed' | å‡ºåº“çŠ¶æ€ |
| created_by | VARCHAR(100) | NOT NULL | 'system' | åˆ›å»ºäºº |
| updated_by | VARCHAR(100) | NOT NULL | 'system' | æ›´æ–°äºº |
| created_at | TIMESTAMP | NOT NULL | NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | NOW() | æ›´æ–°æ—¶é—´ |

**å¤–é”®çº¦æŸ**:
```sql
ALTER TABLE outbound_records 
ADD CONSTRAINT fk_outbound_product 
FOREIGN KEY (product_id) REFERENCES products(id) 
ON DELETE CASCADE ON UPDATE CASCADE;
```

**ç´¢å¼•è®¾è®¡**:
```sql
-- å•†å“å¤–é”®ç´¢å¼•
CREATE INDEX idx_outbound_product_id ON outbound_records(product_id);

-- æ—¥æœŸç´¢å¼•
CREATE INDEX idx_outbound_date ON outbound_records(date);

-- çŠ¶æ€ç´¢å¼•
CREATE INDEX idx_outbound_status ON outbound_records(status);

-- å®¢æˆ·åç§°ç´¢å¼•
CREATE INDEX idx_outbound_customer ON outbound_records(customer_name);
```

**ç¤ºä¾‹æ•°æ®**:
```json
{
  "id": 42,
  "product_id": 15,
  "quantity": 10,
  "unit_price": 3.50,
  "total_amount": 35.00,
  "date": "2025-01-08",
  "customer_name": "å¼ ä¸‰",
  "notes": "é›¶å”®å‡ºåº“",
  "status": "completed",
  "created_by": "system",
  "updated_by": "system",
  "created_at": "2025-02-01T10:00:00Z",
  "updated_at": "2025-02-01T10:00:00Z"
}
```

## ğŸ”— è¡¨å…³ç³»è®¾è®¡

### ä¸»è¦å…³è”å…³ç³»

1. **ä¾›åº”å•† â†’ å•†å“** (1:N)
   - `suppliers.id` â†’ `products.supplier_id`
   - ä¸€ä¸ªä¾›åº”å•†å¯ä»¥ä¾›åº”å¤šä¸ªå•†å“
   - å•†å“å¯ä»¥æ²¡æœ‰å…³è”ä¾›åº”å•†ï¼ˆsupplier_idä¸ºNULLï¼‰

2. **å•†å“ â†’ å…¥åº“è®°å½•** (1:N)
   - `products.id` â†’ `inbound_records.product_id`
   - ä¸€ä¸ªå•†å“å¯ä»¥æœ‰å¤šæ¡å…¥åº“è®°å½•

3. **ä¾›åº”å•† â†’ å…¥åº“è®°å½•** (1:N)
   - `suppliers.id` â†’ `inbound_records.supplier_id`
   - ä¸€ä¸ªä¾›åº”å•†å¯ä»¥æœ‰å¤šæ¡å…¥åº“è®°å½•

4. **å•†å“ â†’ å‡ºåº“è®°å½•** (1:N)
   - `products.id` â†’ `outbound_records.product_id`
   - ä¸€ä¸ªå•†å“å¯ä»¥æœ‰å¤šæ¡å‡ºåº“è®°å½•

### å…³è”æŸ¥è¯¢ç¤ºä¾‹

**æŸ¥è¯¢å•†å“åŠå…¶ä¾›åº”å•†ä¿¡æ¯**:
```sql
SELECT 
    p.id,
    p.name AS product_name,
    p.brand,
    p.category,
    p.currentStock,
    s.name AS supplier_name,
    s.contact AS supplier_contact
FROM products p
LEFT JOIN suppliers s ON p.supplier_id = s.id
WHERE p.currentStock > 0
ORDER BY p.name;
```

**æŸ¥è¯¢å…¥åº“è®°å½•è¯¦æƒ…**:
```sql
SELECT 
    ir.id,
    ir.quantity,
    ir.unit_price,
    ir.total_amount,
    ir.date,
    p.name AS product_name,
    p.specification,
    s.name AS supplier_name
FROM inbound_records ir
JOIN products p ON ir.product_id = p.id
JOIN suppliers s ON ir.supplier_id = s.id
WHERE ir.date >= '2025-01-01'
ORDER BY ir.date DESC;
```

**æŸ¥è¯¢å‡ºåº“è®°å½•è¯¦æƒ…**:
```sql
SELECT 
    or.id,
    or.quantity,
    or.unit_price,
    or.total_amount,
    or.date,
    or.customer_name,
    p.name AS product_name,
    p.specification
FROM outbound_records or
JOIN products p ON or.product_id = p.id
WHERE or.date >= '2025-01-01'
ORDER BY or.date DESC;
```

## ğŸ“ˆ ä¸šåŠ¡é€»è¾‘å®ç°

### åº“å­˜ç®¡ç†é€»è¾‘

**å…¥åº“æ“ä½œ**:
1. åˆ›å»ºå…¥åº“è®°å½•
2. æ›´æ–°å•†å“åº“å­˜: `currentStock += quantity`
3. æ›´æ–°å•†å“è¿›è´§ä»·æ ¼ï¼ˆå¯é€‰ï¼‰
4. ç»´æŠ¤ä¾›åº”å•†-å•†å“å…³è”å…³ç³»

```sql
-- å…¥åº“æ“ä½œäº‹åŠ¡
BEGIN;
INSERT INTO inbound_records (product_id, supplier_id, quantity, unit_price, total_amount, date, notes)
VALUES (15, 8, 50, 2.50, 125.00, '2025-01-08', 'æ­£å¸¸å…¥åº“');

UPDATE products 
SET currentStock = currentStock + 50,
    updated_at = NOW()
WHERE id = 15;

-- ç¡®ä¿ä¾›åº”å•†-å•†å“å…³è”å…³ç³»å­˜åœ¨
INSERT INTO supplier_products (supplier_id, product_id, is_primary)
VALUES (8, 15, false)
ON CONFLICT (supplier_id, product_id) DO NOTHING;

COMMIT;
```

**å‡ºåº“æ“ä½œ**:
1. æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
2. åˆ›å»ºå‡ºåº“è®°å½•
3. æ›´æ–°å•†å“åº“å­˜: `currentStock -= quantity`

```sql
-- å‡ºåº“æ“ä½œäº‹åŠ¡
BEGIN;
-- æ£€æŸ¥åº“å­˜
SELECT currentStock FROM products WHERE id = 15 FOR UPDATE;

-- å¦‚æœåº“å­˜å……è¶³ï¼Œæ‰§è¡Œå‡ºåº“
INSERT INTO outbound_records (product_id, quantity, unit_price, total_amount, date, customer_name, notes)
VALUES (15, 10, 3.50, 35.00, '2025-01-08', 'å¼ ä¸‰', 'é›¶å”®å‡ºåº“');

UPDATE products 
SET currentStock = currentStock - 10,
    updated_at = NOW()
WHERE id = 15 AND currentStock >= 10;

-- éªŒè¯åº“å­˜æ›´æ–°æˆåŠŸ
IF NOT FOUND THEN
    ROLLBACK;
    RAISE EXCEPTION 'åº“å­˜ä¸è¶³ï¼Œæ— æ³•å®Œæˆå‡ºåº“æ“ä½œ';
END IF;

COMMIT;
```

### ä¾›åº”å•†å•†å“å…³è”ç®¡ç†

**æ·»åŠ ä¾›åº”å•†-å•†å“å…³è”**:
```sql
-- æ·»åŠ ä¾›åº”å•†-å•†å“å…³è”
INSERT INTO supplier_products (supplier_id, product_id, is_primary)
VALUES (?, ?, ?)
ON CONFLICT (supplier_id, product_id) 
DO UPDATE SET is_primary = EXCLUDED.is_primary;
```

**è®¾ç½®ä¸»è¦ä¾›åº”å•†**:
```sql
-- è®¾ç½®ä¸»è¦ä¾›åº”å•†ï¼ˆç¡®ä¿æ¯ä¸ªå•†å“åªæœ‰ä¸€ä¸ªä¸»è¦ä¾›åº”å•†ï¼‰
BEGIN;

-- å…ˆå–æ¶ˆå…¶ä»–ä¾›åº”å•†çš„ä¸»è¦çŠ¶æ€
UPDATE supplier_products 
SET is_primary = false 
WHERE product_id = ? AND supplier_id != ?;

-- è®¾ç½®æ–°çš„ä¸»è¦ä¾›åº”å•†
UPDATE supplier_products 
SET is_primary = true 
WHERE product_id = ? AND supplier_id = ?;

COMMIT;
```

**åˆ é™¤ä¾›åº”å•†-å•†å“å…³è”**:
```sql
-- åˆ é™¤ä¾›åº”å•†-å•†å“å…³è”
DELETE FROM supplier_products 
WHERE supplier_id = ? AND product_id = ?;
```

### æ•°æ®å®Œæ•´æ€§çº¦æŸ

**æ•°æ®å®Œæ•´æ€§çº¦æŸ**:

1. **å¤–é”®çº¦æŸ**: ç¡®ä¿æ•°æ®å¼•ç”¨å®Œæ•´æ€§
   - `supplier_products.supplier_id` â†’ `suppliers.id`
   - `supplier_products.product_id` â†’ `products.id`
   - `inbound_records.product_id` â†’ `products.id`
   - `inbound_records.supplier_id` â†’ `suppliers.id`
   - `outbound_records.product_id` â†’ `products.id`

2. **å”¯ä¸€çº¦æŸ**: é˜²æ­¢é‡å¤æ•°æ®
   - `suppliers.name` ä¾›åº”å•†åç§°å”¯ä¸€
   - `products.barcode` å•†å“æ¡ç å”¯ä¸€ï¼ˆéç©ºæ—¶ï¼‰
   - `supplier_products(supplier_id, product_id)` ä¾›åº”å•†-å•†å“å…³è”å”¯ä¸€

3. **æ£€æŸ¥çº¦æŸ**: ç¡®ä¿æ•°æ®æœ‰æ•ˆæ€§
```sql
-- ä»·æ ¼å¿…é¡»ä¸ºæ­£æ•°
ALTER TABLE products ADD CONSTRAINT chk_products_price_positive 
CHECK (purchasePrice > 0 AND inputPrice > 0 AND retailPrice > 0);

-- åº“å­˜æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°
ALTER TABLE products ADD CONSTRAINT chk_products_stock_non_negative 
CHECK (currentStock >= 0);

-- å…¥åº“æ•°é‡å¿…é¡»ä¸ºæ­£æ•°
ALTER TABLE inbound_records ADD CONSTRAINT chk_inbound_quantity_positive 
CHECK (quantity > 0 AND unit_price > 0);

-- å‡ºåº“æ•°é‡å¿…é¡»ä¸ºæ­£æ•°
ALTER TABLE outbound_records ADD CONSTRAINT chk_outbound_quantity_positive 
CHECK (quantity > 0 AND unit_price > 0);
```

4. **è§¦å‘å™¨**: è‡ªåŠ¨ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§
```sql
-- è‡ªåŠ¨æ›´æ–°å•†å“çš„updated_atå­—æ®µ
CREATE OR REPLACE FUNCTION update_product_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_product_timestamp
    BEFORE UPDATE ON products
    FOR EACH ROW
    EXECUTE FUNCTION update_product_timestamp();
```

## ğŸ” æŸ¥è¯¢ä¼˜åŒ–

### å¸¸ç”¨æŸ¥è¯¢ç´¢å¼•è®¾è®¡

#### 1. åº“å­˜é¢„è­¦æŸ¥è¯¢
```sql
-- æŸ¥è¯¢åº“å­˜ä¸è¶³çš„å•†å“
SELECT p.*, sp.supplier_id, s.name as supplier_name
FROM products p
LEFT JOIN supplier_products sp ON p.id = sp.product_id AND sp.is_primary = true
LEFT JOIN suppliers s ON sp.supplier_id = s.id
WHERE p.currentStock <= p.stockAlert;

-- ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_products_stock_alert ON products(currentStock, stockAlert);
CREATE INDEX idx_supplier_products_primary ON supplier_products(is_primary) WHERE is_primary = true;
```

#### 2. ä¾›åº”å•†å•†å“æŸ¥è¯¢
```sql
-- æŸ¥è¯¢æŒ‡å®šä¾›åº”å•†çš„æ‰€æœ‰å•†å“
SELECT p.*, sp.is_primary
FROM products p
INNER JOIN supplier_products sp ON p.id = sp.product_id
WHERE sp.supplier_id = ?;

-- ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_supplier_products_supplier ON supplier_products(supplier_id);
```

#### 3. å•†å“ä¾›åº”å•†æŸ¥è¯¢
```sql
-- æŸ¥è¯¢æŒ‡å®šå•†å“çš„æ‰€æœ‰ä¾›åº”å•†
SELECT s.*, sp.is_primary
FROM suppliers s
INNER JOIN supplier_products sp ON s.id = sp.supplier_id
WHERE sp.product_id = ? AND s.status = 'active';

-- ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_supplier_products_product ON supplier_products(product_id);
```

#### 4. é”€å”®ç»Ÿè®¡æŸ¥è¯¢
```sql
-- æŒ‰æœˆç»Ÿè®¡é”€å”®æ•°æ®
SELECT 
    DATE_TRUNC('month', created_at) as month,
    SUM(quantity * unit_price) as total_sales,
    SUM(quantity) as total_quantity
FROM outbound_records 
WHERE created_at >= DATE_TRUNC('year', CURRENT_DATE)
GROUP BY DATE_TRUNC('month', created_at)
ORDER BY month;

-- ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_outbound_records_date ON outbound_records(created_at);
```

#### 5. å…¥åº“å†å²æŸ¥è¯¢
```sql
-- æŸ¥è¯¢å•†å“çš„å…¥åº“å†å²ï¼ˆåŒ…å«ä¾›åº”å•†ä¿¡æ¯ï¼‰
SELECT ir.*, s.name as supplier_name, p.name as product_name
FROM inbound_records ir
INNER JOIN suppliers s ON ir.supplier_id = s.id
INNER JOIN products p ON ir.product_id = p.id
WHERE ir.product_id = ?
ORDER BY ir.created_at DESC;

-- ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_inbound_records_product_date ON inbound_records(product_id, created_at);
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**
   ```sql
   -- ä½¿ç”¨LIMITå’ŒOFFSETè¿›è¡Œåˆ†é¡µ
   SELECT * FROM products 
   ORDER BY id 
   LIMIT 20 OFFSET 0;
   ```

2. **å¤åˆç´¢å¼•ä½¿ç”¨**
   - å°†æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ¡ä»¶æ”¾åœ¨ç´¢å¼•å‰é¢
   - è€ƒè™‘æŸ¥è¯¢çš„é€‰æ‹©æ€§å’Œé¢‘ç‡

3. **é¿å…å…¨è¡¨æ‰«æ**
   - åœ¨WHEREå­å¥ä¸­ä½¿ç”¨ç´¢å¼•å­—æ®µ
   - é¿å…åœ¨ç´¢å¼•å­—æ®µä¸Šä½¿ç”¨å‡½æ•°

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨

### å¤‡ä»½ç­–ç•¥
- **è‡ªåŠ¨å¤‡ä»½**: Supabaseæä¾›è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½
- **å®šæœŸå¯¼å‡º**: å®šæœŸå¯¼å‡ºé‡è¦æ•°æ®
- **ç‰ˆæœ¬æ§åˆ¶**: æ•°æ®åº“ç»“æ„å˜æ›´ç‰ˆæœ¬æ§åˆ¶

### æƒé™æ§åˆ¶
- **è¡Œçº§å®‰å…¨**: ä½¿ç”¨Supabase RLSåŠŸèƒ½
- **APIæƒé™**: é€šè¿‡APIå±‚æ§åˆ¶æ•°æ®è®¿é—®
- **å®¡è®¡æ—¥å¿—**: è®°å½•é‡è¦æ“ä½œæ—¥å¿—

## âœ… æ•°æ®åº“ç»“æ„éªŒè¯

### è¡¨ç»“æ„éªŒè¯æŸ¥è¯¢

```sql
-- éªŒè¯æ‰€æœ‰è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT table_name, table_type 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('suppliers', 'products', 'supplier_products', 'inbound_records', 'outbound_records');

-- éªŒè¯å¤–é”®çº¦æŸ
SELECT 
    tc.table_name, 
    tc.constraint_name, 
    tc.constraint_type,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
    AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY' 
AND tc.table_schema = 'public';

-- éªŒè¯ç´¢å¼•åˆ›å»º
SELECT 
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes 
WHERE schemaname = 'public'
AND tablename IN ('suppliers', 'products', 'supplier_products', 'inbound_records', 'outbound_records')
ORDER BY tablename, indexname;
```

### æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

```sql
-- æ£€æŸ¥å­¤ç«‹çš„å•†å“è®°å½•ï¼ˆæ²¡æœ‰ä¾›åº”å•†å…³è”ï¼‰
SELECT p.id, p.name 
FROM products p
LEFT JOIN supplier_products sp ON p.id = sp.product_id
WHERE sp.product_id IS NULL;

-- æ£€æŸ¥å…¥åº“è®°å½•çš„æ•°æ®å®Œæ•´æ€§
SELECT COUNT(*) as invalid_inbound_records
FROM inbound_records ir
LEFT JOIN products p ON ir.product_id = p.id
LEFT JOIN suppliers s ON ir.supplier_id = s.id
WHERE p.id IS NULL OR s.id IS NULL;

-- æ£€æŸ¥å‡ºåº“è®°å½•çš„æ•°æ®å®Œæ•´æ€§
SELECT COUNT(*) as invalid_outbound_records
FROM outbound_records or_
LEFT JOIN products p ON or_.product_id = p.id
WHERE p.id IS NULL;

-- æ£€æŸ¥ä¾›åº”å•†-å•†å“å…³è”çš„å®Œæ•´æ€§
SELECT COUNT(*) as invalid_supplier_product_relations
FROM supplier_products sp
LEFT JOIN suppliers s ON sp.supplier_id = s.id
LEFT JOIN products p ON sp.product_id = p.id
WHERE s.id IS NULL OR p.id IS NULL;
```

### æ€§èƒ½æµ‹è¯•æŸ¥è¯¢

```sql
-- æµ‹è¯•åº“å­˜é¢„è­¦æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT p.*, sp.supplier_id, s.name as supplier_name
FROM products p
LEFT JOIN supplier_products sp ON p.id = sp.product_id AND sp.is_primary = true
LEFT JOIN suppliers s ON sp.supplier_id = s.id
WHERE p.currentStock <= p.stockAlert;

-- æµ‹è¯•ä¾›åº”å•†å•†å“æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT p.*, sp.is_primary
FROM products p
INNER JOIN supplier_products sp ON p.id = sp.product_id
WHERE sp.supplier_id = 1;
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.1.0 (2025-02-01)
- **å­—æ®µå¢å¼º**: ä¸º `inbound_records` å’Œ `outbound_records` è¡¨æ·»åŠ å®¡è®¡å­—æ®µ
- **æ–°å¢å­—æ®µ**: `created_by` - è®°å½•åˆ›å»ºäººï¼Œé»˜è®¤å€¼ 'system'
- **æ–°å¢å­—æ®µ**: `updated_by` - è®°å½•æ›´æ–°äººï¼Œé»˜è®¤å€¼ 'system'
- **è§¦å‘å™¨**: æ·»åŠ è‡ªåŠ¨æ›´æ–° `updated_at` æ—¶é—´æˆ³çš„è§¦å‘å™¨
- **æ•°æ®å®Œæ•´æ€§**: è§£å†³å‰ç«¯å…¥åº“æ“ä½œä¸­çš„å­—æ®µç¼ºå¤±é—®é¢˜

### v2.0.0 (2025-01-31)
- **é‡å¤§å˜æ›´**: å°†ä¾›åº”å•†-å•†å“å…³ç³»ä»ä¸€å¯¹å¤šæ”¹ä¸ºå¤šå¯¹å¤š
- **æ–°å¢**: `supplier_products` ä¸­é—´è¡¨ç®¡ç†ä¾›åº”å•†-å•†å“å…³è”
- **ç§»é™¤**: `products` è¡¨ä¸­çš„ `supplier_id` å¤–é”®å­—æ®µ
- **ä¼˜åŒ–**: æ›´æ–°æ‰€æœ‰ç›¸å…³æŸ¥è¯¢å’Œç´¢å¼•è®¾è®¡
- **å¢å¼º**: æ”¯æŒä¸€ä¸ªå•†å“å¯¹åº”å¤šä¸ªä¾›åº”å•†çš„ä¸šåŠ¡åœºæ™¯

### v1.0.0 (2025-01-08)
- åˆå§‹æ•°æ®åº“è®¾è®¡
- åŸºç¡€è¡¨ç»“æ„å®šä¹‰
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°

---

**âœ… æ•°æ®åº“ç»“æ„éªŒè¯é€šè¿‡** - æ‰€æœ‰è¡¨ã€çº¦æŸã€ç´¢å¼•å’Œè§¦å‘å™¨å·²æ­£ç¡®åˆ›å»ºå¹¶éªŒè¯å®Œæˆã€‚

---

**è®¾è®¡åŸåˆ™**: æœ¬æ•°æ®åº“è®¾è®¡éµå¾ªå…³ç³»å‹æ•°æ®åº“è§„èŒƒåŒ–åŸåˆ™ï¼Œé€šè¿‡å¤–é”®å…³è”ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œé‡‡ç”¨åˆç†çš„ç´¢å¼•ç­–ç•¥æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œä¸ºä¾¿åˆ©åº—è¿›é”€å­˜ç³»ç»Ÿæä¾›ç¨³å®šå¯é çš„æ•°æ®æ”¯æ’‘ã€‚